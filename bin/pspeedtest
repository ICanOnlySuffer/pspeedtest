#!/usr/bin/env ruby

require_relative '../lib/pspeedtest'
require_relative '../lib/pspeedtest/cli/version'
require_relative '../lib/pspeedtest/cli/help'

CLI = {
	download: [],
	upload: [],
	rescue: true,
	debug: "",
	delay: 0,
	runs: 1.times
}

ARGV.each do |arg|
	option, value = arg.split '=', 2
	
	case option
	when '--help', '-h' then help value
	when '--version', '-v' then version
	when '--download' then CLI[:download] = value.split.map &:to_i
	when '--upload' then CLI[:upload] = value.split.map &:to_i
	when '--rescue' then CLI[:rescue] = value == 'true'
	when '--debug' then CLI[:debug] = value.gsub '\n', ?\n
	when '--delay' then CLI[:delay] = value.to_i
	when '--runs' then CLI[:runs] = value ? value.to_i.times : loop
	when '--file' then $stdout = File.new value, 'a'
	else help nil
	end
end

$stdout.sync = true
PSpeedTest::USER.update!

def test
	PSpeedTest::SERVER.update!
	distance = PSpeedTest::SERVER.distance
	time = Time.now
	
	download = PSpeedTest::SERVER.download CLI[:download]
	upload = PSpeedTest::SERVER.upload CLI[:upload]
	
	print CLI[:debug] % {
		'host': PSpeedTest::SERVER.host,
		'sponsor': PSpeedTest::SERVER.sponsor,
		'latency': PSpeedTest::SERVER.latency,
		'latitude': PSpeedTest::SERVER.lat,
		'longitude': PSpeedTest::SERVER.lon,
		
		'distance': distance,
		'distance.m': distance * 1000,
		'distance.mi': distance * 0.62137119,
		
		'download.num': download.bps.first,
		'download.str': download.bps.last,
		'download.bits': download.bits,
		'download.time': download.time,
		
		'upload.num': upload.bps.first,
		'upload.str': upload.bps.last,
		'upload.bits': upload.bits,
		'upload.time': upload.time,
		
		'time.to_i': time.to_i,
		'time.hms': (time.strftime "%H:%M:%S"),
		'time': time
	}
end

looped = false
CLI[:runs].each do
	begin
		test
	rescue => error
		raise error unless CLI[:rescue]
	end
	
	if looped
		sleep CLI[:delay]
	else
		looped = true
	end
end











