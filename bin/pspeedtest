#!/usr/bin/env ruby

require 'pspeedtest/help' if ARGV.empty?

CLI = {
	download: [],
	upload: [],
	debug: '',
	delay: 0,
	runs: 1.times
}

ARGV.each do |arg|
	option, value = arg.split '=', 2
	
	case option
	when '--version' then require 'pspeedtest/version'
	when '--download' then CLI[:download] = value.split.map &:to_i
	when '--upload' then CLI[:upload] = value.split.map &:to_i
	when '--debug' then CLI[:debug] = value.gsub '\n', ?\n
	when '--delay' then CLI[:delay] = value.to_i
	when '--runs' then CLI[:runs] = value ? value.to_i.times : loop
	when '--file' then $stdout = File.new value, 'a'
	else require 'pspeedtest/help'
	end
end

require 'pspeedtest'
$stdout.sync = true

TOTAL = {
	download: (PSpeedTest::Speed.new 0, 0),
	upload: (PSpeedTest::Speed.new 0, 0)
}

CLI[:runs].each do
	sleep CLI[:delay]
	
	PSpeedTest::SERVER.update!
	time = Time.now
	
	download = PSpeedTest::SERVER.download CLI[:download]
	upload = PSpeedTest::SERVER.upload CLI[:upload]
	
	TOTAL[:download].bits += download.bits
	TOTAL[:download].time += download.time
	TOTAL[:upload].bits += upload.bits
	TOTAL[:upload].time += upload.time
	
	print CLI[:debug] % {
		'host': PSpeedTest::SERVER.host,
		'sponsor': PSpeedTest::SERVER.sponsor,
		'latency': PSpeedTest::SERVER.latency,
		'latitude': PSpeedTest::SERVER.lat,
		'longitude': PSpeedTest::SERVER.lon,
		
		'total.download.num': TOTAL[:download].bps.first,
		'total.download.str': TOTAL[:download].bps.last,
		'total.download.bits': TOTAL[:download].bits,
		'total.download.time': TOTAL[:download].time,
		
		'total.upload.num': TOTAL[:upload].bps.first,
		'total.upload.str': TOTAL[:upload].bps.last,
		'total.upload.bits': TOTAL[:upload].bits,
		'total.upload.time': TOTAL[:upload].time,
		
		'download.num': download.bps.first,
		'download.str': download.bps.last,
		'download.bits': download.bits,
		'download.time': download.time,
		
		'upload.num': upload.bps.first,
		'upload.str': upload.bps.last,
		'upload.bits': upload.bits,
		'upload.time': upload.time,
		
		'time.ymd.hms': (time.strftime '%F %X'),
		'time.hms': (time.strftime '%X'),
		'time.int': time.to_i,
		'time': time
	}
rescue => error
	$stderr.puts "\e[31m#{error.message}\e[0m"
rescue Interrupt
	$stderr.puts
	exit
end

